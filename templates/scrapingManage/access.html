<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIdu | 접속 통계</title>
  <link href="{{ url_for('static', filename='style/common.css') }}" rel="stylesheet" />
  <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/common.js') }}"></script>
  <script src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
</head>


<body>
  <div class="container">
    <main class="main-area">
      <h2 class="title">접속 통계</h2>
      <div class="table-area">
        <div class="flex align-center justify-between sub-title-wrap">
          <div class="flex align-end gap-xs">
            <h3 class="sub-title">실시간 접속</h3>
          </div>
        </div>
        <table class="table">
          <caption>실시간 접속 통계 테이블</caption>
          <colgroup>
            <col width="50%" />
            <col />
          </colgroup>
          <thead class="thead type2">
            <tr>
              <th>접속자</th>
              <th>첫 접속자</th>
            </tr>
          </thead>
          <tbody id="topTbody" class="tbody no-row-line"></tbody>
        </table>
      </div>
      <div class="filter-wrap">
        <div class="search-form flex active">
          <ul class="filter-btns flex">
            <li><button class="btn lg tertiary" id="today" onclick="onbtn(this); btnSearch();">오늘</button></li>
            <li><button class="btn lg tertiary off" id="week" onclick="onbtn(this);; btnSearch();">금주</button></li>
            <li><button class="btn lg tertiary off" id="month" onclick="onbtn(this); btnSearch();">금월</button></li>
            <li><button class="btn lg tertiary off" id="custom" onclick="onbtn(this)">직접</button></li>
          </ul>
          <div class="date-wrap flex align-center">
            <div class="date-box"><input type="date" id="startDay"></div>
            <span class="unit">~</span>
            <div class="date-box"><input type="date" id="endDay"></div>
          </div>
          <button id="DateSearchBtn" type="button" class="btn primary md search-btn" onclick="btnSearch()">검색</button>
        </div>
        <p class="caution">※ 직접 검색 시 최대 검색 기간은 1개월입니다.</p>
      </div>
      <div class="table-area">
        <table class="table">
          <caption>기간 기준 전체 검색 테이블</caption>
          <colgroup>
            <col width="33.33%" />
            <col width="33.33%" />
            <col />
          </colgroup>
          <thead class="thead type2">
            <tr>
              <th>검색 조건</th>
              <th>접속 (Total)</th>
              <th>첫 접속자 (Total)</th>
            </tr>
          </thead>
          <tbody class="tbody no-row-line" id="middleTbody"></tbody>
        </table>
      </div>
      <div class="table-area">
        <table class="table detail-table">
          <caption>일별 검색 결과 테이블</caption>
          <colgroup>
            <col width="33.33%" />
            <col width="33.33%" />
            <col />
          </colgroup>
          <thead class="thead type3-2">
            <tr>
              <th>날짜</th>
              <th>접속자</th>
              <th>첫 접속자</th>
            </tr>
          </thead>
          <tbody class="tbody" id="bottomTbody"></tbody>
        </table>
      </div>
    </main>
  </div>
</body>
<script>


  //날짜 전역 변수
  const todayUTC = moment.utc().format('YYYY-MM-DD');


  $(document).ready(
    session_ok("{{domain}}", "{{port}}"),
    searchTopAccess(),
    SearchBottom(),
    escCloseModal(),
    setToday(),
    DateSearchBtn()
  )

  function btnSearch() {
    session_ok("{{domain}}", "{{port}}");
    let startDay = $(".active").find("input#startDay").val()
    let endDay = $(".active").find("input#endDay").val()
    SearchBottom(startDay, endDay)
  }


  //초기 데이터 조회
  function searchTopAccess() {
    $.ajax({
      url: "{{domain}}:{{port}}/SearchAccess",
      type: "POST",
      contentType: "application/json",
      dataType: "json",
      data: JSON.stringify([]),
      success: function (response) {
        console.log(response)
        header_values = `
            <tr>
              <td>${response['total']}</td>
              <td>${response['first']}</td>
            </tr>`
        $("#topTbody").append(header_values)
      }
    })
  }


  function SearchBottom(startDay = todayUTC, endDay = todayUTC) {
    $.ajax({
      url: "{{domain}}:{{port}}/SearchAccessByDay",
      type: "POST",
      contentType: "application/json",
      dataType: "json",
      data: JSON.stringify([startDay, endDay]),
      success: function (response) {
        console.log(response)

        middle_values = ``
        bottom_values = ``
        // 성공 후 기존 데이터가 있을 시 제거
        if ($("#bottomTbody").children().length !== 0 || $("#topTbody").children().length !== 0) {
          $("#bottomTbody, #middleTbody").empty();
        }
        // 검색 결과가 없을 경우
        if (response.length == 0) {
          values = `<p>검색 결과가 없습니다.</p>`
          OpenModal('검색 결과 없음', "", false, false, "", "", "", true, "sm", values)

          //단건일 경우
        } else {
          response.forEach((v, i) => {
            bottom_values += `
            <tr>
              <td>${v['reg_date']}</td>
              <td class="total">${v['total']}</td>
              <td class="first">${v['first']}</td>
            </tr>`
          });
          $("#bottomTbody").append(bottom_values)
        }

        middle_values += `
        <tr>
            <td>${startDay} ~ ${endDay}</td>
            <td>${calculateTotal("total")}</td>
            <td>${calculateTotal("first")}</td>
          </tr>`
        $("#middleTbody").append(middle_values)
      }
    })
  }
</script>

</html>
<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FinTime | 금융사 정보 관리</title>
  <link href="{{ url_for('static', filename='style/common.css') }}" rel="stylesheet" />
  <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/common.js') }}"></script>

</head>

<body>
  <div class="container">
    <main class="main-area">
      <h2 class="title">금융사 정보 관리</h2>
      <form class="search-form">
        <div class="input-wrap">
          <input id="searchInput" class="input" placeholder="기관명 입력 후 검색" />
          <span class="delete-btn"></span>
        </div>
        <div class="select-box md" style="margin-left: 16px;">
          <strong class="label" onclick="ClickSelectLabel('corGp')" id="corGp" name="">전체</strong>
          <ul class="options type">
            <li class="option" onclick="ClickSelectOption('corGp','전체','')">
              전체
            </li>
            <li class="option" onclick="ClickSelectOption('corGp','은행','001')">
              은행
            </li>
            <li class="option" onclick="ClickSelectOption('corGp','증권','002')">
              증권
            </li>
            <li class="option" onclick="ClickSelectOption('corGp','카드','003')">
              카드
            </li>
            <li class="option" onclick="ClickSelectOption('corGp','보험','004')">
              보험
            </li>
          </ul>
        </div>
        <div class="select-box md" style="margin-left: 16px;">
          <strong class="label" onclick="ClickSelectLabel('useYn')" id="useYn" name="">전체</strong>
          <ul class="options type">
            <li class="option" onclick="ClickSelectOption('useYn','전체','')">
              전체
            </li>
            <li class="option" onclick="ClickSelectOption('useYn','사용',' Y')">
              사용
            </li>
            <li class="option" onclick="ClickSelectOption('useYn','미사용','N')">
              미사용
            </li>
          </ul>
        </div>
        <button id="searchBtn" class="btn primary md search-btn">검색</button>
      </form>
      <div class="table-area">
        <div class="flex justify-between align-end">
          <strong class="count"></strong>
          <button class="btn tertiary sm" id="addBtn" onclick=""> + 기관 추가</button>
        </div>
        <table class="table intent-table">
          <caption>기관 관리 테이블</caption>
          <colgroup>
            <col width="80px" />
            <col width="80px"/>
            <col width="100px"/>
            <col />
            <col />
            <col />
            <col width="80px" />
            <col />
            <col />
          </colgroup>
          <thead class="thead type2">
            <tr>
              <th>기관번호</th>
              <th>기관그룹</th>
              <th>기관명</th>
              <th>기관설명</th>
              <th>대표이미지</th>
              <th>썸네일이미지</th>
              <th>사용여부</th>
              <th>최초등록일</th>
              <th>최종수정일</th>
            </tr>
          </thead>
          <tbody id="dataContent" class="tbody"></tbody>
        </table>
      </div>
      <button id="moreContent" class="btn tertiary sm">더보기</button>
    </main>
  </div>
</body>
<script>
  //세션
  let session_check = "{{session}}";
  if (session_check == 'None') {
    top.location.href = '/';
  }

  $(document).ready(function () {
    SearchGroupCode()
    fn_eventHandler()
  })



  function fn_eventHandler(){
    //기관추가 btn
    $("#addBtn").click(function () {
    addModal()
  })
  // row dbClick
    $("#dataContent").on('dblclick', 'tr', function() {
      addModal(this)
  });  

    //검색 기능
    $("#searchBtn").click(function (e) {
    e.preventDefault();

    search_data = {
      cor_nm : $('#searchInput').val(),
      cor_gp : $('#corGp').attr('name'),
      use_yn : $('#useYn').attr('name')
    }

    SearchGroupCode(search_data)
  })

  }

  function modifyGroup(){
    console.log("수정 임~~")
  }

  function addGroup(){
    console.log("등록 임~~")
  }



  //모달 
  function addModal(tag=false) {
    //모달 setting
    var modal_title = tag ? "기관 수정" : "기관 추가"
    var fn_name = tag? addGroup : modifyGroup

    //요소 바인딩
    var title = tag ? $(tag).find("td").eq(2).text() : ""
    var cor_name = tag ? $(tag).find("td").eq(1).text() : ""
    var cor_gp = tag ? $(tag).attr("data-id") : ""
    var cor_noti = tag ? $(tag).find("td").eq(3).text() : ""
    var img_url = tag ? $(tag).find("td").eq(4).text() : ""
    var thumbnail_url = tag ? $(tag).find("td").eq(5).text() : ""
    values = `
                    <h3>기관명</h3>
                    <fieldset>
                        <div class="input-wrap">
                            <input id="corNmInput" class="input" placeholder="기관명을 입력 해 주세요" 
                                onfocus="FocusInput('corNmInput')" oninput="ChangeInput('corNmInput')" onblur="BlurInput('corNmInput')"
                                value="${title}">
                            <span class="delete-btn" onclick="DeleteInput('corNmInput')"></span>
                        </div>
                    </fieldset>
                    <br>
                    <h3>기관그룹 선택</h3>
                    <fieldset>
                      <div class="select-box md" style="width:100%">
                        <strong class="label" onclick="ClickSelectLabel('corGrpSel')" id="corGrpSel" name="${cor_gp}">선택하세요</strong>
                        <ul class="options type">
                          <li class="option" onclick="ClickSelectOption('corGrpSel','은행','001')">
                            은행
                          </li>
                          <li class="option" onclick="ClickSelectOption('corGrpSel','증권','002')">
                            증권
                          </li>
                          <li class="option" onclick="ClickSelectOption('corGrpSel','카드','003')">
                            카드
                          </li>
                          <li class="option" onclick="ClickSelectOption('corGrpSel','보험','004')">
                            보험
                          </li>
                        </ul>
                      </div>
                    </fieldset>
                    <br>
                    <h3>기관 설명</h3>
                    <fieldset>
                        <textarea id="corNotiInput" class="textarea" onfocus="FocusInput('corNotiInput')"
                            placeholder="기관 설명을 입력 해 주세요" value="${cor_noti}"></textarea>
                    </fieldset>
                    <h3>대표이미지 URL</h3>
                    <fieldset>
                        <div class="input-wrap">
                            <input id="imgUrlInput" class="input" placeholder="대표 이미지 URL을 입력 해 주세요" 
                                onfocus="FocusInput('imgUrlInput')" oninput="ChangeInput('imgUrlInput')" onblur="BlurInput('imgUrlInput')"
                                value="${img_url}">
                            <span class="delete-btn" onclick="DeleteInput('imgUrlInput')"></span>
                        </div>
                    </fieldset>
                    <h3>썸네일이미지 URL</h3>
                    <fieldset>
                        <div class="input-wrap">
                            <input id="thumbUrlInput" class="input" placeholder="썸네일 이미지 URL을 입력 해 주세요" 
                                onfocus="FocusInput('thumbUrlInput')" oninput="ChangeInput('thumbUrlInput')" onblur="BlurInput('thumbUrlInput')"
                                value="${thumbnail_url}">
                            <span class="delete-btn" onclick="DeleteInput('thumbUrlInput')"></span>
                        </div>
                    </fieldset>    `
    OpenModal(modal_title, "", true, true, `${fn_name}()`, "확인", "취소", "", "md", values)
    
    if(tag){
      ClickSelectOption("corGrpSel",cor_name,cor_gp)
    }
  }

  let default_page = 0
  let limit = 10
  let totalData

  // 조회
  function SearchGroupCode(data={}) {
    $.ajax({
      url: "{{domain}}:{{port}}/contentMange",
      type: "POST",
      contentType: "application/json",
      dataType: "json",
      data: JSON.stringify(data),
      success: function (response) {
        totalData = []

        //초기화
        $("#dataContent tr").remove()
        $(".count").text(`Total : ${response.length}`);
        default_page = 0
        
        totalData.push(response)

        //화면 불러오기 + 더보기 버튼
        loadPagedData(default_page, limit, totalData)
        moreBtn()
      }
    });
  }



  function moreBtn() {
      $("#moreContent").click(function (e) {
        e.preventDefault()
        default_page++; // 다음 페이지로 이동
        loadPagedData(default_page, limit, totalData);
      })
    }

  function loadPagedData(page, limit, totalData) {
      let start = page * limit;
      let end = start + limit;
      let pagedData = totalData[0].slice(start, end);
      paging(pagedData);
    }

    function paging(res) {
      var oHtml = '';
      $.each(res, function (i, v) {
        oHtml += `    
            <tr data-id="${v['COR_GP']}" name="${v['COR_GP']}" explain="${v['group_info']}">
              <td>${v['COR_NO']}</td>
              <td>${v['GP_NM']}</td>
              <td>${v['COR_NM']}</td>
              <td>${v['COR_NOTI']}</td>
              <td>${v['IMG_URL']}</td>
              <td>${v['THUMBNAIL_URL']}</td>
              <td>${v['USE_YN']}</td>
              <td>${v['C_DATE']}</td>
              <td>${v['U_DATE']}</td>
            </tr>`;
      });
      $("#dataContent").append(oHtml);
    }

</script>

</html>
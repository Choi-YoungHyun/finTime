<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 로그 모니터링</title>
    
    <!-- jQuery 및 Socket.IO -->
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/socket.io.js') }}"></script>
    
    <!-- 스타일 -->
    <link href="{{ url_for('static', filename='style/common.css') }}" rel="stylesheet" />
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            text-align: center;
        }
        h2 {
            color: #333;
        }
        select, button, input {
            margin: 5px;
            padding: 8px;
            font-size: 14px;
        }
        #log-container {
            width: 80%;
            max-width: 900px;
            height: 400px;
            margin: 20px auto;
            background: white;
            border: 1px solid #ccc;
            overflow-y: auto;
            text-align: left;
            padding: 10px;
            font-family: monospace;
        }
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h2>실시간 로그 모니터링</h2>
    
    <label for="log-files">로그 파일 선택:</label>
    <select id="log-files"></select>
    <button onclick="loadLogs()">조회</button>
    
    <div>
        <input type="text" id="search-input" placeholder="검색어 입력">
        <button onclick="searchLogs()">검색</button>
        <button onclick="nextResult()">다음</button>
    </div>
    
    <div id="log-container"></div>
    
    <script>
        const socket = io.connect();
        const logContainer = document.getElementById("log-container");
        const searchInput = document.getElementById("search-input");
        const logFilesSelect = document.getElementById("log-files");
        let logs = [];
        let searchResults = [];
        let currentIndex = -1;

        // 서버에서 로그 파일 목록 가져오기
        fetch("/log_files")
            .then(response => response.json())
            .then(files => {
                files.forEach(file => {
                    let option = document.createElement("option");
                    option.value = file;
                    option.textContent = file;
                    logFilesSelect.appendChild(option);
                });
            });
        
        function loadLogs() {
            logContainer.innerHTML = "";
            logs = [];
            let selectedFile = logFilesSelect.value;
            socket.emit("request_logs", { filename: selectedFile });
        }
        
        socket.on("log_update", (data) => {
            const logEntry = document.createElement("pre");
            logEntry.textContent = data;
            logEntry.classList.add("log-entry");
            logContainer.appendChild(logEntry);
            logs.push(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        });
        
        function searchLogs() {
            const keyword = searchInput.value.trim().toLowerCase();
            if (!keyword) return;
            logs.forEach(log => log.classList.remove("highlight"));
            searchResults = logs.filter(log => log.textContent.toLowerCase().includes(keyword));
            currentIndex = 0;
            moveToResult();
        }

        function moveToResult() {
            if (searchResults.length > 0) {
                searchResults.forEach(log => log.classList.remove("highlight"));
                searchResults[currentIndex].classList.add("highlight");
                searchResults[currentIndex].scrollIntoView({ behavior: "smooth", block: "center" });
            }
        }
        
        function nextResult() {
            if (searchResults.length > 0) {
                currentIndex = (currentIndex + 1) % searchResults.length;
                moveToResult();
            }
        }
    </script>
</body>
</html>